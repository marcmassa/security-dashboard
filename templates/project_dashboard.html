{% extends "base.html" %}

{% block title %}{{ project.name }} - Security Dashboard{% endblock %}

{% block content %}
<div class="main-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            <li class="breadcrumb-item active">{{ project.name }}</li>
        </ol>
    </nav>

    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">{{ project.name }}</h1>
        <p class="dashboard-subtitle">
            Security analysis dashboard for your project
        </p>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
        <h2 class="text-center mb-4">Upload Security Reports</h2>
        <div class="upload-grid">
            <!-- SonarQube Upload -->
            <div class="upload-card" data-report-type="sonarqube" data-project-id="{{ project.id }}">
                <div class="upload-icon">
                    <i data-feather="code"></i>
                </div>
                <h3 class="upload-title">SonarQube Report</h3>
                <p class="upload-description">Upload SonarQube analysis results (JSON format)</p>
                <input type="file" class="file-input" accept=".json" />
                <button class="upload-button">Upload Report</button>
            </div>

            <!-- SBOM Upload -->
            <div class="upload-card" data-report-type="sbom" data-project-id="{{ project.id }}">
                <div class="upload-icon">
                    <i data-feather="package"></i>
                </div>
                <h3 class="upload-title">SBOM Report</h3>
                <p class="upload-description">Upload CycloneDX SBOM file (JSON/XML format)</p>
                <input type="file" class="file-input" accept=".json,.xml" />
                <button class="upload-button">Upload Report</button>
            </div>

            <!-- Trivy Upload -->
            <div class="upload-card" data-report-type="trivy" data-project-id="{{ project.id }}">
                <div class="upload-icon">
                    <i data-feather="search"></i>
                </div>
                <h3 class="upload-title">Trivy Report</h3>
                <p class="upload-description">Upload Trivy container scan results (JSON/HTML format)</p>
                <input type="file" class="file-input" accept=".json,.html" />
                <button class="upload-button">Upload Report</button>
            </div>
        </div>
    </div>

    <!-- Summary Dashboard -->
    <div class="summary-grid">
        <!-- SonarQube Summary -->
        <div class="summary-card {% if not project.reports.sonarqube %}disabled{% endif %}" id="sonarqube-summary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="card-icon" data-feather="code"></i>
                    SonarQube Analysis
                </h3>
                <a href="{{ url_for('project_sonarqube_detail', project_id=project.id) }}" class="detail-button">
                    {% if project.reports.sonarqube %}View Details{% else %}Configure SonarQube{% endif %}
                </a>
            </div>
            
            {% if project.reports.sonarqube %}
            <div class="project-name mb-3">
                <strong>Project:</strong> {{ project.reports.sonarqube.project_name }}
            </div>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value severity-critical" data-metric="bugs">{{ project.reports.sonarqube.bugs }}</div>
                    <div class="metric-label">Bugs</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-high" data-metric="vulnerabilities">{{ project.reports.sonarqube.vulnerabilities }}</div>
                    <div class="metric-label">Vulnerabilities</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-medium" data-metric="code-smells">{{ project.reports.sonarqube.code_smells }}</div>
                    <div class="metric-label">Code Smells</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-low" data-metric="coverage">{{ project.reports.sonarqube.coverage }}%</div>
                    <div class="metric-label">Coverage</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-medium" data-metric="duplicated-lines">{{ project.reports.sonarqube.duplicated_lines_density }}%</div>
                    <div class="metric-label">Duplication</div>
                </div>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i data-feather="bar-chart-2"></i>
                </div>
                <div class="empty-state-text">No SonarQube Data</div>
                <div class="empty-state-subtext">Configure connection or upload a report to see code quality metrics</div>
                
                <!-- Configuration and Upload Options -->
                <div class="mt-4">
                    {% include 'sonarqube_config.html' %}
                    
                    <div class="mt-3 text-center">
                        <span class="text-muted">or</span>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <label class="btn btn-outline-primary">
                            <i data-feather="upload"></i> Upload JSON Report
                            <input type="file" class="d-none upload-input" data-report-type="sonarqube" accept=".json">
                        </label>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- SBOM Summary -->
        <div class="summary-card {% if not project.reports.sbom %}disabled{% endif %}" id="sbom-summary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="card-icon" data-feather="package"></i>
                    SBOM Vulnerabilities
                </h3>
                <a href="{{ url_for('project_sbom_detail', project_id=project.id) }}" class="detail-button">
                    {% if project.reports.sbom %}View Details{% else %}Upload SBOM{% endif %}
                </a>
            </div>
            
            {% if project.reports.sbom %}
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value severity-critical" data-metric="critical">{{ project.reports.sbom.vulnerabilities.by_severity.critical }}</div>
                    <div class="metric-label">Critical</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-high" data-metric="high">{{ project.reports.sbom.vulnerabilities.by_severity.high }}</div>
                    <div class="metric-label">High</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-medium" data-metric="medium">{{ project.reports.sbom.vulnerabilities.by_severity.medium }}</div>
                    <div class="metric-label">Medium</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-low" data-metric="low">{{ project.reports.sbom.vulnerabilities.by_severity.low }}</div>
                    <div class="metric-label">Low</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value" data-metric="total-components">{{ project.reports.sbom.components.total }}</div>
                    <div class="metric-label">Components</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="sbom-chart"></canvas>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i data-feather="upload-cloud"></i>
                </div>
                <div class="empty-state-text">No SBOM Data</div>
                <div class="empty-state-subtext">Upload an SBOM report to see dependency vulnerabilities</div>
            </div>
            {% endif %}
        </div>

        <!-- Trivy Summary -->
        <div class="summary-card {% if not project.reports.trivy %}disabled{% endif %}" id="trivy-summary">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="card-icon" data-feather="search"></i>
                    Trivy Container Scan
                </h3>
                <a href="{{ url_for('project_trivy_detail', project_id=project.id) }}" class="detail-button">
                    {% if project.reports.trivy %}View Details{% else %}Upload Trivy{% endif %}
                </a>
            </div>
            
            {% if project.reports.trivy %}
            <div class="artifact-name mb-3">
                <strong>Artifact:</strong> {{ project.reports.trivy.artifact_name }}
            </div>
            <div class="metrics-grid">
                <div class="metric-item">
                    <div class="metric-value severity-critical" data-metric="critical">{{ project.reports.trivy.vulnerabilities.by_severity.CRITICAL }}</div>
                    <div class="metric-label">Critical</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-high" data-metric="high">{{ project.reports.trivy.vulnerabilities.by_severity.HIGH }}</div>
                    <div class="metric-label">High</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-medium" data-metric="medium">{{ project.reports.trivy.vulnerabilities.by_severity.MEDIUM }}</div>
                    <div class="metric-label">Medium</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-low" data-metric="low">{{ project.reports.trivy.vulnerabilities.by_severity.LOW }}</div>
                    <div class="metric-label">Low</div>
                </div>
                <div class="metric-item">
                    <div class="metric-value severity-unknown" data-metric="unknown">{{ project.reports.trivy.vulnerabilities.by_severity.UNKNOWN }}</div>
                    <div class="metric-label">Unknown</div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="trivy-chart"></canvas>
            </div>
            {% else %}
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i data-feather="upload-cloud"></i>
                </div>
                <div class="empty-state-text">No Trivy Data</div>
                <div class="empty-state-subtext">Upload a Trivy scan report to see container vulnerabilities</div>
            </div>
            {% endif %}
        </div>
    </div>


</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts on page load
document.addEventListener('DOMContentLoaded', function() {
    {% if project.reports.sbom %}
    createSBOMChart({{ project.reports.sbom.vulnerabilities.by_severity | tojson }});
    {% endif %}
    
    {% if project.reports.trivy %}
    createTrivyChart({{ project.reports.trivy.vulnerabilities.by_severity | tojson }});
    {% endif %}
});

// SonarQube configuration functions
async function connectToSonarQube() {
    const connectBtn = document.querySelector('.btn-primary');
    const spinner = connectBtn.querySelector('.spinner-border');
    
    // Get configuration values
    const globalUrl = document.getElementById('globalSonarUrl').value;
    const globalToken = document.getElementById('globalSonarToken').value;
    const projectKey = document.getElementById('projectSonarKey').value;
    const projectToken = document.getElementById('projectSonarToken').value;
    
    // Validate required fields
    if (!globalUrl || !projectKey) {
        showNotification('error', 'Please provide SonarQube server URL and project key');
        return;
    }
    
    if (!globalToken && !projectToken) {
        showNotification('error', 'Please provide either a global token or project-specific token');
        return;
    }
    
    // Use project token if available, otherwise global token
    const tokenToUse = projectToken || globalToken;
    
    // Show loading state
    connectBtn.disabled = true;
    if (spinner) spinner.classList.remove('d-none');
    
    try {
        const response = await fetch(`/api/projects/{{ project.id }}/sonarqube/fetch`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sonar_url: globalUrl,
                sonar_token: tokenToUse,
                sonar_project_key: projectKey
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showNotification('success', `Successfully connected to SonarQube! Project: ${result.project_name}`);
            
            // Reload page after short delay
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            // Show detailed error message with suggestions
            let errorMessage = result.message || result.error || 'Failed to connect to SonarQube';
            if (result.suggestions && result.suggestions.length > 0) {
                errorMessage += '\n\nSuggestions:\n• ' + result.suggestions.join('\n• ');
            }
            showNotification('error', errorMessage);
        }
    } catch (error) {
        console.error('Connection error:', error);
        showNotification('error', 'Connection failed. Please check your network and try again.');
    } finally {
        // Reset loading state
        connectBtn.disabled = false;
        if (spinner) spinner.classList.add('d-none');
    }
}

async function testSonarQubeConnection() {
    const globalUrl = document.getElementById('globalSonarUrl').value;
    const globalToken = document.getElementById('globalSonarToken').value;
    const projectToken = document.getElementById('projectSonarToken').value;
    
    if (!globalUrl) {
        showNotification('error', 'Please provide SonarQube server URL');
        return;
    }
    
    const tokenToUse = projectToken || globalToken;
    if (!tokenToUse) {
        showNotification('error', 'Please provide a token');
        return;
    }
    
    try {
        const response = await fetch('/api/sonarqube/test-connection', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sonar_url: globalUrl,
                sonar_token: tokenToUse
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showNotification('success', `Connection successful! SonarQube version: ${result.version}`);
        } else {
            showNotification('error', result.error || 'Connection test failed');
        }
    } catch (error) {
        showNotification('error', 'Connection test failed. Please check your network.');
    }
}

async function saveGlobalConfig() {
    const globalUrl = document.getElementById('globalSonarUrl').value;
    const globalToken = document.getElementById('globalSonarToken').value;
    
    if (!globalUrl) {
        showNotification('error', 'Please provide SonarQube server URL');
        return;
    }
    
    try {
        const response = await fetch('/api/sonarqube/save-config', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                sonar_url: globalUrl,
                sonar_token: globalToken
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            showNotification('success', 'Global configuration saved successfully');
        } else {
            showNotification('error', result.error || 'Failed to save configuration');
        }
    } catch (error) {
        showNotification('error', 'Failed to save configuration. Please try again.');
    }
}

// Notification function
function showNotification(type, message) {
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 400px; max-width: 500px; white-space: pre-line;';
    notification.innerHTML = `
        <div style="font-weight: 500; margin-bottom: ${message.includes('\n') ? '8px' : '0'};">
            ${message.split('\n')[0]}
        </div>
        ${message.includes('\n') ? `<div style="font-size: 0.9em; opacity: 0.9;">${message.split('\n').slice(1).join('\n')}</div>` : ''}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after longer time for error messages
    const timeout = type === 'error' ? 10000 : 5000;
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, timeout);
}
</script>
{% endblock %}