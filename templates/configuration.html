{% extends "base.html" %}

{% block title %}Configuration - Security Dashboard{% endblock %}

{% block content %}
<style>
    /* Fix active menu item color to blue */
    .list-group-item.active {
        background-color: #3b82f6 !important;
        border-color: #3b82f6 !important;
        color: #ffffff !important;
    }
    
    /* Fix card header to blue instead of gray */
    .card-header {
        background-color: #3b82f6 !important;
        border-bottom: 1px solid #1e40af !important;
        color: #ffffff !important;
    }
    
    /* Make form text white instead of gray */
    .form-text {
        color: #ffffff !important;
    }
    
    /* Fix muted text to white */
    .text-muted {
        color: #ffffff !important;
    }
    
    /* Fix card title in header */
    .card-header .card-title {
        color: #ffffff !important;
        font-weight: 600 !important;
    }
    
    /* Fix alert info text */
    .alert-info {
        background-color: #1e40af !important;
        border-color: #3b82f6 !important;
        color: #ffffff !important;
    }
</style>

<div class="main-container">
    <!-- Page Header -->
    <div class="dashboard-header">
        <h1 class="dashboard-title">Configuration</h1>
        <p class="dashboard-subtitle">
            Manage system settings and integrations
        </p>
    </div>
    
    <div class="d-flex justify-content-end mb-4">
        <button class="btn btn-primary" onclick="saveAllConfiguration()">
            <i data-feather="save" class="me-1"></i>
            Save All Changes
        </button>
    </div>

    <div class="row">
        <!-- Navigation Sidebar -->
        <div class="col-lg-3 col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-body p-0">
                    <div class="list-group list-group-flush">
                        <a class="list-group-item list-group-item-action active" href="#general" onclick="showSection('general')">
                            <i data-feather="sliders" class="me-2"></i>
                            General Settings
                        </a>
                        <a class="list-group-item list-group-item-action" href="#sonarqube" onclick="showSection('sonarqube')">
                            <i data-feather="server" class="me-2"></i>
                            SonarQube Integration
                        </a>
                        <a class="list-group-item list-group-item-action text-muted" href="#sso" onclick="showSection('sso')">
                            <i data-feather="users" class="me-2"></i>
                            SSO/SAML Authentication
                            <small class="text-muted d-block">Coming Soon</small>
                        </a>
                        <a class="list-group-item list-group-item-action text-muted" href="#notifications" onclick="showSection('notifications')">
                            <i data-feather="bell" class="me-2"></i>
                            Notifications
                            <small class="text-muted d-block">Coming Soon</small>
                        </a>
                        <a class="list-group-item list-group-item-action text-muted" href="#security" onclick="showSection('security')">
                            <i data-feather="shield" class="me-2"></i>
                            Security Settings
                            <small class="text-muted d-block">Coming Soon</small>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 col-md-8">
            <!-- General Settings Section -->
            <div id="general-section" class="config-section">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="sliders" class="me-2"></i>
                            General Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="dashboard-title" class="form-label">Dashboard Title</label>
                                    <input type="text" class="form-control" id="dashboard-title" 
                                           value="Security Analysis Dashboard" 
                                           placeholder="Enter dashboard title">
                                    <div class="form-text">
                                        Customize the main dashboard title
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="auto-refresh" class="form-label">Auto Refresh Interval (minutes)</label>
                                    <select class="form-select" id="auto-refresh">
                                        <option value="5">5 minutes</option>
                                        <option value="15" selected>15 minutes</option>
                                        <option value="30">30 minutes</option>
                                        <option value="60">1 hour</option>
                                        <option value="0">Disabled</option>
                                    </select>
                                    <div class="form-text">
                                        Automatic dashboard refresh frequency
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="max-upload-size" class="form-label">Max Upload Size (MB)</label>
                                    <input type="number" class="form-control" id="max-upload-size" 
                                           value="50" min="1" max="500">
                                    <div class="form-text">
                                        Maximum file size for report uploads
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">Theme Settings</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="dark-mode" checked>
                                        <label class="form-check-label" for="dark-mode">
                                            Dark Mode (Default)
                                        </label>
                                    </div>
                                    <div class="form-text">
                                        Interface appearance preferences
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SonarQube Integration Section -->
            <div id="sonarqube-section" class="config-section" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="server" class="me-2"></i>
                            SonarQube Server Integration
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i data-feather="info" class="me-2"></i>
                            Configure your SonarQube server connection to enable direct API integration and real-time data fetching.
                        </div>
                        
                        <form id="sonarqube-config-form">
                            <div class="mb-3">
                                <label for="sonar-url" class="form-label">SonarQube Server URL</label>
                                <input type="url" class="form-control" id="sonar-url" 
                                       value="{{ sonarqube_config.sonar_url }}" 
                                       placeholder="https://sonarqube.company.com"
                                       required>
                                <div class="form-text">
                                    The base URL of your SonarQube server (e.g., https://sonarqube.company.com)
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="sonar-token" class="form-label">Authentication Token</label>
                                <div class="input-group">
                                    <input type="password" class="form-control" id="sonar-token" 
                                           placeholder="{% if sonarqube_config.has_token %}••••••••••••••••{% else %}Enter your SonarQube token{% endif %}">
                                    <button class="btn btn-outline-secondary" type="button" onclick="toggleTokenVisibility()">
                                        <i data-feather="eye" id="token-eye"></i>
                                    </button>
                                </div>
                                <div class="form-text">
                                    Your personal SonarQube authentication token
                                </div>
                            </div>

                            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                <button type="button" class="btn btn-outline-primary" onclick="testSonarQubeConnection()">
                                    <i data-feather="wifi" class="me-1"></i>
                                    Test Connection
                                </button>
                                <button type="button" class="btn btn-success" onclick="saveSonarQubeConfig()">
                                    <i data-feather="save" class="me-1"></i>
                                    Save Configuration
                                </button>
                            </div>
                        </form>

                        <!-- Connection Status -->
                        <div id="connection-status" class="mt-3" style="display: none;">
                            <div class="alert" id="status-alert">
                                <i data-feather="check-circle" class="me-2"></i>
                                <span id="status-message">Connection successful!</span>
                            </div>
                        </div>

                        <!-- Help Section -->
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary">
                                            <i data-feather="key" class="me-2"></i>
                                            Creating Authentication Tokens
                                        </h6>
                                        <ol class="small mb-0 text-body">
                                            <li>Log into your SonarQube instance</li>
                                            <li>Go to <strong>User → My Account</strong></li>
                                            <li>Click <strong>Security</strong> tab</li>
                                            <li>Enter token name and click <strong>Generate</strong></li>
                                            <li>Copy the generated token immediately</li>
                                        </ol>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border">
                                    <div class="card-body">
                                        <h6 class="card-title text-success">
                                            <i data-feather="shield" class="me-2"></i>
                                            Required Permissions
                                        </h6>
                                        <ul class="small mb-0 text-body">
                                            <li><strong>Browse</strong> - View project metrics</li>
                                            <li><strong>Execute Analysis</strong> - Access detailed reports</li>
                                            <li><strong>Admin</strong> - Full project access (recommended)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- SSO/SAML Section -->
            <div id="sso-section" class="config-section" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="users" class="me-2"></i>
                            SSO/SAML Authentication
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i data-feather="clock" class="me-2"></i>
                            This feature is coming soon. SSO/SAML authentication integration will be available in a future update.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notifications Section -->
            <div id="notifications-section" class="config-section" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="bell" class="me-2"></i>
                            Notifications
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i data-feather="clock" class="me-2"></i>
                            Notification settings will be available in a future update.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security Settings Section -->
            <div id="security-section" class="config-section" style="display: none;">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i data-feather="shield" class="me-2"></i>
                            Security Settings
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <i data-feather="clock" class="me-2"></i>
                            Advanced security settings will be available in a future update.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Feather icons
    feather.replace();
});

// Configuration section switching
function showSection(sectionName) {
    // Hide all sections
    const sections = document.querySelectorAll('.config-section');
    sections.forEach(section => {
        section.style.display = 'none';
    });
    
    // Remove active class from all nav items
    const navItems = document.querySelectorAll('.list-group-item');
    navItems.forEach(item => {
        item.classList.remove('active');
    });
    
    // Show selected section
    const targetSection = document.getElementById(sectionName + '-section');
    if (targetSection) {
        targetSection.style.display = 'block';
    }
    
    // Add active class to clicked nav item
    const activeItem = document.querySelector(`[href="#${sectionName}"]`);
    if (activeItem) {
        activeItem.classList.add('active');
    }
}

// Configuration functions
function saveAllConfiguration() {
    // TODO: Implement save all configuration
    alert('Configuration saved successfully!');
}

function testSonarQubeConnection() {
    const url = document.getElementById('sonar-url').value;
    const token = document.getElementById('sonar-token').value;
    
    if (!url || !token) {
        alert('Please enter both URL and token before testing connection.');
        return;
    }
    
    // TODO: Implement actual connection test
    const statusDiv = document.getElementById('connection-status');
    const statusAlert = document.getElementById('status-alert');
    const statusMessage = document.getElementById('status-message');
    
    statusAlert.className = 'alert alert-success';
    statusMessage.textContent = 'Connection test successful!';
    statusDiv.style.display = 'block';
    
    feather.replace();
}

function saveSonarQubeConfig() {
    // TODO: Implement SonarQube config save
    alert('SonarQube configuration saved successfully!');
}

function toggleTokenVisibility() {
    const tokenInput = document.getElementById('sonar-token');
    const eyeIcon = document.getElementById('token-eye');
    
    if (tokenInput.type === 'password') {
        tokenInput.type = 'text';
        eyeIcon.setAttribute('data-feather', 'eye-off');
    } else {
        tokenInput.type = 'password';
        eyeIcon.setAttribute('data-feather', 'eye');
    }
    
    feather.replace();
}
</script>
{% endblock %}