{% extends "base.html" %}

{% block title %}Trivy Report Details - Security Dashboard{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            {% if project %}
            <li class="breadcrumb-item"><a href="{{ url_for('project_dashboard', project_id=project.id) }}">{{ project.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">Trivy Details</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">Trivy Container Scan Report</h1>
            <p class="text-muted">{{ data.artifact_name }} ({{ data.artifact_type }})</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="exportToPDF()">
                <i data-feather="download"></i> Export PDF
            </button>
            <button class="btn btn-outline-primary" onclick="exportToJSON()">
                <i data-feather="file-text"></i> Export JSON
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value">{{ data.vulnerabilities.total }}</div>
                <div class="metric-label">Total Vulnerabilities</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-critical">{{ data.vulnerabilities.by_severity.CRITICAL }}</div>
                <div class="metric-label">Critical</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-high">{{ data.vulnerabilities.by_severity.HIGH }}</div>
                <div class="metric-label">High</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-medium">{{ data.vulnerabilities.by_severity.MEDIUM }}</div>
                <div class="metric-label">Medium</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-low">{{ data.vulnerabilities.by_severity.LOW }}</div>
                <div class="metric-label">Low</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-unknown">{{ data.vulnerabilities.by_severity.UNKNOWN }}</div>
                <div class="metric-label">Unknown</div>
            </div>
        </div>
    </div>

    <!-- Vulnerability Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Vulnerability Distribution</h5>
                <div class="chart-container">
                    <canvas id="vulnerability-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Risk Assessment</h5>
                <div class="chart-container">
                    <canvas id="risk-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Results -->
    {% for result in data.results %}
    <div class="summary-card mb-4">
        <div class="card-header">
            <h5 class="card-title">
                <i data-feather="package"></i>
                {{ result.Target }}
                {% if result.Type %}
                <span class="badge badge-info ms-2">{{ result.Type }}</span>
                {% endif %}
            </h5>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Filter by Severity</label>
                    <select class="form-select severity-filter" data-target="vulnerabilities-table-{{ loop.index }}">
                        <option value="">All Severities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Search CVE</label>
                    <input type="text" class="form-control cve-search" data-target="vulnerabilities-table-{{ loop.index }}" placeholder="Search CVE ID...">
                </div>
                <div>
                    <label class="form-label">Search Package</label>
                    <input type="text" class="form-control package-search" data-target="vulnerabilities-table-{{ loop.index }}" placeholder="Search package name...">
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="sortVulnerabilityTable('vulnerabilities-table-{{ loop.index }}')">
                        <i data-feather="arrow-up-down"></i> Sort by CVSS
                    </button>
                </div>
            </div>
        </div>

        {% if result.Vulnerabilities %}
        <div class="table-responsive">
            <table class="table table-striped" id="vulnerabilities-table-{{ loop.index }}">
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>Package</th>
                        <th>Version</th>
                        <th>Severity</th>
                        <th>CVSS Score</th>
                        <th>Fixed Version</th>
                        <th>Title</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in result.Vulnerabilities %}
                    <tr>
                        <td>
                            <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.VulnerabilityID }}" target="_blank">
                                {{ vuln.VulnerabilityID }}
                            </a>
                        </td>
                        <td>{{ vuln.PkgName }}</td>
                        <td>{{ vuln.InstalledVersion }}</td>
                        <td>
                            <span class="badge badge-{{ vuln.Severity.lower() }}">{{ vuln.Severity }}</span>
                        </td>
                        <td>
                            {% if vuln.CVSS %}
                                {% for cvss_version, cvss_data in vuln.CVSS.items() %}
                                    {{ cvss_data.V3Score or cvss_data.V2Score or 'N/A' }}
                                    {% break %}
                                {% endfor %}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>{{ vuln.FixedVersion or 'Not Available' }}</td>
                        <td>
                            {% if vuln.Title %}
                            {{ vuln.Title[:80] }}{% if vuln.Title|length > 80 %}...{% endif %}
                            {% else %}
                            No title available
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-success text-center">
            <i data-feather="check-circle"></i>
            No vulnerabilities found in {{ result.Target }}
        </div>
        {% endif %}
    </div>
    {% endfor %}

    {% if not data.results %}
    <div class="summary-card">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i data-feather="search"></i>
            </div>
            <div class="empty-state-text">No scan results available</div>
            <div class="empty-state-subtext">The Trivy report contains no vulnerability data</div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeVulnerabilityChart();
    initializeRiskChart();
    setupFilters();
});

function initializeVulnerabilityChart() {
    const ctx = document.getElementById('vulnerability-chart').getContext('2d');
    const vulnerabilities = {{ data.vulnerabilities.by_severity | tojson }};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
            datasets: [{
                label: 'Vulnerabilities',
                data: [
                    vulnerabilities.CRITICAL,
                    vulnerabilities.HIGH,
                    vulnerabilities.MEDIUM,
                    vulnerabilities.LOW,
                    vulnerabilities.UNKNOWN
                ],
                backgroundColor: [
                    'hsl(var(--critical))',
                    'hsl(var(--high))',
                    'hsl(var(--medium))',
                    'hsl(var(--low))',
                    'hsl(var(--unknown))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function initializeRiskChart() {
    const ctx = document.getElementById('risk-chart').getContext('2d');
    const vulnerabilities = {{ data.vulnerabilities.by_severity | tojson }};
    
    // Calculate risk score (weighted by severity)
    const riskScore = (vulnerabilities.CRITICAL * 4) + 
                     (vulnerabilities.HIGH * 3) + 
                     (vulnerabilities.MEDIUM * 2) + 
                     (vulnerabilities.LOW * 1);
    
    const maxRisk = 100; // Arbitrary max for display
    const riskPercentage = Math.min((riskScore / maxRisk) * 100, 100);
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [riskPercentage, 100 - riskPercentage],
                backgroundColor: [
                    riskPercentage > 75 ? 'hsl(var(--critical))' :
                    riskPercentage > 50 ? 'hsl(var(--high))' :
                    riskPercentage > 25 ? 'hsl(var(--medium))' : 'hsl(var(--low))',
                    'hsl(var(--border))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Add risk score text in center
    const chartContainer = ctx.canvas.parentElement;
    const riskText = document.createElement('div');
    riskText.style.position = 'absolute';
    riskText.style.top = '50%';
    riskText.style.left = '50%';
    riskText.style.transform = 'translate(-50%, -50%)';
    riskText.style.textAlign = 'center';
    riskText.innerHTML = `
        <div style="font-size: 2rem; font-weight: bold; color: ${riskPercentage > 75 ? 'hsl(var(--critical))' : riskPercentage > 50 ? 'hsl(var(--high))' : riskPercentage > 25 ? 'hsl(var(--medium))' : 'hsl(var(--low))'}">${Math.round(riskPercentage)}%</div>
        <div style="font-size: 0.8rem; color: hsl(var(--secondary-foreground))">Risk Score</div>
    `;
    chartContainer.style.position = 'relative';
    chartContainer.appendChild(riskText);
}

function setupFilters() {
    // Setup severity filters
    document.querySelectorAll('.severity-filter').forEach(filter => {
        filter.addEventListener('change', function() {
            const tableId = this.dataset.target;
            filterTableByColumn(tableId, this.value, 3); // Severity column
        });
    });
    
    // Setup CVE search
    document.querySelectorAll('.cve-search').forEach(search => {
        search.addEventListener('input', function() {
            const tableId = this.dataset.target;
            filterTableByColumn(tableId, this.value, 0); // CVE ID column
        });
    });
    
    // Setup package search
    document.querySelectorAll('.package-search').forEach(search => {
        search.addEventListener('input', function() {
            const tableId = this.dataset.target;
            filterTableByColumn(tableId, this.value, 1); // Package column
        });
    });
}

function filterTableByColumn(tableId, filterValue, columnIndex) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const cell = row.cells[columnIndex];
        if (cell) {
            const cellText = cell.textContent.toLowerCase();
            if (filterValue === '' || cellText.includes(filterValue.toLowerCase())) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }
}

function sortVulnerabilityTable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    rows.sort((a, b) => {
        const aScore = parseFloat(a.cells[4].textContent) || 0; // CVSS Score column
        const bScore = parseFloat(b.cells[4].textContent) || 0;
        return bScore - aScore; // Descending order
    });
    
    // Clear tbody and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function exportToPDF() {
    window.print();
}

function exportToJSON() {
    const data = {{ data | tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trivy-report.json';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
