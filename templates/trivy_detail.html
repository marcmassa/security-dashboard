{% extends "base.html" %}

{% block title %}Trivy Report Details - Security Dashboard{% endblock %}

{% block content %}
<style>
.trivy-table-container {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid var(--bs-border-color);
    border-radius: 0.375rem;
    position: relative;
    resize: vertical;
    min-height: 300px;
}

.trivy-table-container .table {
    font-size: 0.875rem;
    margin-bottom: 0;
}

.trivy-table-container .table td,
.trivy-table-container .table th {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
}

.trivy-table-container .table thead th {
    position: sticky;
    top: 0;
    background-color: var(--bs-dark);
    z-index: 10;
}

.vulnerability-row .cve-link {
    font-weight: 600;
    text-decoration: none;
}

.vulnerability-row .package-name {
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.8rem;
    background-color: rgba(108, 117, 125, 0.1);
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
}

.severity-badge {
    font-size: 0.7rem !important;
    font-weight: 500;
    min-width: 60px;
    text-align: center;
}

.cvss-score {
    font-weight: 600;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

@media (max-width: 768px) {
    .trivy-table-container {
        max-height: 300px;
    }
    
    .trivy-table-container .table {
        font-size: 0.8rem;
    }
    
    .trivy-table-container .table td,
    .trivy-table-container .table th {
        padding: 0.25rem 0.5rem;
    }
}
</style>
<div class="detail-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            {% if project %}
            <li class="breadcrumb-item"><a href="{{ url_for('project_dashboard', project_id=project.id) }}">{{ project.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">Trivy Details</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">Trivy Container Scan Report</h1>
            <p class="text-muted">{{ data.artifact_name }} ({{ data.artifact_type }})</p>
        </div>
        <div>
            <button class="btn btn-outline-success me-2" onclick="triggerTrivyUpload()">
                <i data-feather="upload"></i> Upload New Report
            </button>
            <button class="btn btn-outline-primary me-2" onclick="exportToPDF()">
                <i data-feather="download"></i> Export PDF
            </button>
            <button class="btn btn-outline-primary" onclick="exportToJSON()">
                <i data-feather="file-text"></i> Export JSON
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value">{{ data.vulnerabilities.total }}</div>
                <div class="metric-label">Total Vulnerabilities</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-critical">{{ data.vulnerabilities.by_severity.CRITICAL }}</div>
                <div class="metric-label">Critical</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-high">{{ data.vulnerabilities.by_severity.HIGH }}</div>
                <div class="metric-label">High</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-medium">{{ data.vulnerabilities.by_severity.MEDIUM }}</div>
                <div class="metric-label">Medium</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-low">{{ data.vulnerabilities.by_severity.LOW }}</div>
                <div class="metric-label">Low</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-unknown">{{ data.vulnerabilities.by_severity.UNKNOWN }}</div>
                <div class="metric-label">Unknown</div>
            </div>
        </div>
    </div>

    <!-- Vulnerability Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Vulnerability Distribution</h5>
                <div class="chart-container">
                    <canvas id="vulnerability-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Risk Assessment</h5>
                <div class="chart-container">
                    <canvas id="risk-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Scan Results -->
    {% for result in data.results %}
    <div class="summary-card mb-4">
        <div class="card-header">
            <h5 class="card-title">
                <i data-feather="package"></i>
                {{ result.Target }}
                {% if result.Type %}
                <span class="badge badge-info ms-2">{{ result.Type }}</span>
                {% endif %}
            </h5>
        </div>

        <!-- Filter Controls -->
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Filter by Severity</label>
                    <select class="form-select severity-filter" data-target="vulnerabilities-table-{{ loop.index }}">
                        <option value="">All Severities</option>
                        <option value="CRITICAL">Critical</option>
                        <option value="HIGH">High</option>
                        <option value="MEDIUM">Medium</option>
                        <option value="LOW">Low</option>
                        <option value="UNKNOWN">Unknown</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Search CVE</label>
                    <input type="text" class="form-control cve-search" data-target="vulnerabilities-table-{{ loop.index }}" placeholder="Search CVE ID...">
                </div>
                <div>
                    <label class="form-label">Search Package</label>
                    <input type="text" class="form-control package-search" data-target="vulnerabilities-table-{{ loop.index }}" placeholder="Search package name...">
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="sortVulnerabilityTable('vulnerabilities-table-{{ loop.index }}')">
                        <i data-feather="arrow-up"></i> Sort by CVSS
                    </button>
                </div>
            </div>
        </div>

        {% if result.Vulnerabilities %}
        <div class="trivy-table-container">
            <table class="table table-striped table-hover" id="vulnerabilities-table-{{ loop.index }}">
                <thead class="table-dark">
                    <tr>
                        <th style="min-width: 140px;">CVE ID</th>
                        <th style="min-width: 180px;">Package</th>
                        <th style="min-width: 100px;">Version</th>
                        <th style="min-width: 80px;">Severity</th>
                        <th style="min-width: 80px;">CVSS Score</th>
                        <th style="min-width: 120px;">Fixed Version</th>
                        <th style="min-width: 200px;">Title</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in result.Vulnerabilities %}
                    <tr class="vulnerability-row">
                        <td>
                            <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.VulnerabilityID }}" target="_blank" class="cve-link">
                                {{ vuln.VulnerabilityID }}
                            </a>
                        </td>
                        <td>
                            <span class="package-name">{{ vuln.PkgName }}</span>
                        </td>
                        <td>
                            <code class="small">{{ vuln.InstalledVersion }}</code>
                        </td>
                        <td>
                            <span class="badge severity-badge bg-{{ 'danger' if vuln.Severity == 'CRITICAL' else 'warning' if vuln.Severity == 'HIGH' else 'info' if vuln.Severity == 'MEDIUM' else 'secondary' }}">
                                {{ vuln.Severity }}
                            </span>
                        </td>
                        <td>
                            <span class="cvss-score">
                            {% if vuln.CVSS %}
                                {% set cvss_scores = [] %}
                                {% for cvss_version, cvss_data in vuln.CVSS.items() %}
                                    {% if cvss_data.V3Score %}
                                        {% set _ = cvss_scores.append(cvss_data.V3Score) %}
                                    {% elif cvss_data.V2Score %}
                                        {% set _ = cvss_scores.append(cvss_data.V2Score) %}
                                    {% endif %}
                                {% endfor %}
                                {{ cvss_scores[0] if cvss_scores else 'N/A' }}
                            {% else %}
                                N/A
                            {% endif %}
                            </span>
                        </td>
                        <td>
                            {% if vuln.FixedVersion %}
                            <code class="small text-success">{{ vuln.FixedVersion }}</code>
                            {% else %}
                            <span class="text-muted">Not Available</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-truncate" style="max-width: 200px;" title="{{ vuln.Title or 'No title available' }}">
                                {{ vuln.Title[:60] if vuln.Title else 'No title available' }}{% if vuln.Title and vuln.Title|length > 60 %}...{% endif %}
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert alert-success text-center">
            <i data-feather="check-circle"></i>
            No vulnerabilities found in {{ result.Target }}
        </div>
        {% endif %}
    </div>
    {% endfor %}

    {% if not data.results %}
    <div class="summary-card">
        <div class="empty-state">
            <div class="empty-state-icon">
                <i data-feather="search"></i>
            </div>
            <div class="empty-state-text">No scan results available</div>
            <div class="empty-state-subtext">The Trivy report contains no vulnerability data</div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Hidden file input for Trivy upload -->
<input type="file" id="trivy-file-input" accept=".json" style="display: none;" onchange="handleTrivyUpload(this)">

{% endblock %}

{% block scripts %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeVulnerabilityChart();
    initializeRiskChart();
    setupFilters();
});

function initializeVulnerabilityChart() {
    const ctx = document.getElementById('vulnerability-chart').getContext('2d');
    const vulnerabilities = {{ data.vulnerabilities.by_severity | tojson }};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low', 'Unknown'],
            datasets: [{
                label: 'Vulnerabilities',
                data: [
                    vulnerabilities.CRITICAL,
                    vulnerabilities.HIGH,
                    vulnerabilities.MEDIUM,
                    vulnerabilities.LOW,
                    vulnerabilities.UNKNOWN
                ],
                backgroundColor: [
                    'hsl(var(--critical))',
                    'hsl(var(--high))',
                    'hsl(var(--medium))',
                    'hsl(var(--low))',
                    'hsl(var(--unknown))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

function initializeRiskChart() {
    const ctx = document.getElementById('risk-chart').getContext('2d');
    const vulnerabilities = {{ data.vulnerabilities.by_severity | tojson }};
    
    // Calculate risk score (weighted by severity)
    const riskScore = (vulnerabilities.CRITICAL * 4) + 
                     (vulnerabilities.HIGH * 3) + 
                     (vulnerabilities.MEDIUM * 2) + 
                     (vulnerabilities.LOW * 1);
    
    const maxRisk = 100; // Arbitrary max for display
    const riskPercentage = Math.min((riskScore / maxRisk) * 100, 100);
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            datasets: [{
                data: [riskPercentage, 100 - riskPercentage],
                backgroundColor: [
                    riskPercentage > 75 ? 'hsl(var(--critical))' :
                    riskPercentage > 50 ? 'hsl(var(--high))' :
                    riskPercentage > 25 ? 'hsl(var(--medium))' : 'hsl(var(--low))',
                    'hsl(var(--border))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%',
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
    
    // Add risk score text in center
    const chartContainer = ctx.canvas.parentElement;
    const riskText = document.createElement('div');
    riskText.style.position = 'absolute';
    riskText.style.top = '50%';
    riskText.style.left = '50%';
    riskText.style.transform = 'translate(-50%, -50%)';
    riskText.style.textAlign = 'center';
    riskText.innerHTML = `
        <div style="font-size: 2rem; font-weight: bold; color: ${riskPercentage > 75 ? 'hsl(var(--critical))' : riskPercentage > 50 ? 'hsl(var(--high))' : riskPercentage > 25 ? 'hsl(var(--medium))' : 'hsl(var(--low))'}">${Math.round(riskPercentage)}%</div>
        <div style="font-size: 0.8rem; color: hsl(var(--secondary-foreground))">Risk Score</div>
    `;
    chartContainer.style.position = 'relative';
    chartContainer.appendChild(riskText);
}

function setupFilters() {
    // Setup severity filters
    document.querySelectorAll('.severity-filter').forEach(filter => {
        filter.addEventListener('change', function() {
            const tableId = this.dataset.target;
            filterTableByColumn(tableId, this.value, 3); // Severity column
        });
    });
    
    // Setup CVE search
    document.querySelectorAll('.cve-search').forEach(search => {
        search.addEventListener('input', function() {
            const tableId = this.dataset.target;
            filterTableByColumn(tableId, this.value, 0); // CVE ID column
        });
    });
    
    // Setup package search
    document.querySelectorAll('.package-search').forEach(search => {
        search.addEventListener('input', function() {
            const tableId = this.dataset.target;
            filterTableByColumn(tableId, this.value, 1); // Package column
        });
    });
}

function filterTableByColumn(tableId, filterValue, columnIndex) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');
    
    for (let row of rows) {
        const cell = row.cells[columnIndex];
        if (cell) {
            const cellText = cell.textContent.toLowerCase();
            if (filterValue === '' || cellText.includes(filterValue.toLowerCase())) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        }
    }
}

function sortVulnerabilityTable(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    
    const tbody = table.getElementsByTagName('tbody')[0];
    const rows = Array.from(tbody.getElementsByTagName('tr'));
    
    rows.sort((a, b) => {
        const aScore = parseFloat(a.cells[4].textContent) || 0; // CVSS Score column
        const bScore = parseFloat(b.cells[4].textContent) || 0;
        return bScore - aScore; // Descending order
    });
    
    // Clear tbody and re-append sorted rows
    tbody.innerHTML = '';
    rows.forEach(row => tbody.appendChild(row));
}

function exportToPDF() {
    window.print();
}

function exportToJSON() {
    const data = {{ data | tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'trivy-report.json';
    a.click();
    URL.revokeObjectURL(url);
}

function triggerTrivyUpload() {
    document.getElementById('trivy-file-input').click();
}

function handleTrivyUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    const validTypes = ['application/json'];
    const validExtensions = ['.json'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    
    if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
        showNotification('error', 'Please select a valid Trivy JSON report file');
        return;
    }
    
    // Show loading state
    const uploadBtn = document.querySelector('[onclick="triggerTrivyUpload()"]');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<i data-feather="loader"></i> Uploading...';
    uploadBtn.disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('report_type', 'trivy');
    
    // Get project ID from current URL
    const projectId = window.location.pathname.split('/')[2];
    
    // Upload file
    fetch(`/project/${projectId}/upload`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'Trivy report uploaded successfully! Reloading page...');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showNotification('error', data.error || 'Failed to upload Trivy report');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showNotification('error', 'Error uploading file. Please try again.');
    })
    .finally(() => {
        // Restore button state
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        feather.replace();
        
        // Clear file input
        input.value = '';
    });
}

// Create Trivy chart function for dashboard.js compatibility
function createTrivyChart(vulnerabilities) {
    const ctx = document.getElementById('trivy-chart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    vulnerabilities.CRITICAL || 0,
                    vulnerabilities.HIGH || 0,
                    vulnerabilities.MEDIUM || 0,
                    vulnerabilities.LOW || 0
                ],
                backgroundColor: [
                    'hsl(var(--critical))',
                    'hsl(var(--high))',
                    'hsl(var(--medium))',
                    'hsl(var(--low))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
{% endblock %}
