{% extends "base.html" %}

{% block title %}SBOM Report Details - Security Dashboard{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Page Header -->
    <div class="page-header">
        <div class="page-header-content">
            <div class="page-title-section">
                <h1 class="page-title">SBOM Report</h1>
                <p class="page-subtitle">Software Bill of Materials analysis and component dependency tracking</p>
            </div>
            <div class="page-actions">
                <button class="btn btn-outline-secondary me-2" onclick="exportToPDF()">
                    <i data-feather="download" class="me-1"></i>
                    Export PDF
                </button>
                <button class="btn btn-primary" onclick="window.print()">
                    <i data-feather="printer" class="me-1"></i>
                    Print Report
                </button>
            </div>
        </div>
    </div>

    <!-- Project Navigation -->
    <div class="project-nav-section">
        <div class="project-nav-tabs">
            <a href="{{ url_for('project_dashboard', project_id=project.id) }}" class="project-nav-tab">
                <i data-feather="bar-chart-2" class="me-1"></i>
                Overview
            </a>
            <a href="{{ url_for('project_sonarqube_detail', project_id=project.id) }}" class="project-nav-tab">
                <i data-feather="code" class="me-1"></i>
                SonarQube
            </a>
            <a href="{{ url_for('project_sbom_detail', project_id=project.id) }}" class="project-nav-tab active">
                <i data-feather="package" class="me-1"></i>
                SBOM
            </a>
            <a href="{{ url_for('project_trivy_detail', project_id=project.id) }}" class="project-nav-tab">
                <i data-feather="alert-triangle" class="me-1"></i>
                Trivy
            </a>
        </div>
    </div>
</div>

<style>
#component-details-table {
    font-size: 0.875rem;
}

#component-details-table td {
    padding: 0.5rem 0.75rem;
    vertical-align: middle;
}

#component-details-table .text-truncate {
    max-width: 1px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

#component-details-table .fw-bold {
    font-weight: 600;
}

#component-details-table code {
    background-color: rgba(108, 117, 125, 0.1);
    color: #212529;
    padding: 0.125rem 0.25rem;
    border-radius: 0.25rem;
    font-size: 0.8rem;
    border: 1px solid rgba(108, 117, 125, 0.2);
}

[data-bs-theme="dark"] #component-details-table code {
    background-color: rgba(255, 255, 255, 0.1);
    color: #f8f9fa;
    border: 1px solid rgba(255, 255, 255, 0.2);
}

#component-details-table .text-muted {
    color: #6c757d !important;
}

[data-bs-theme="dark"] #component-details-table .text-muted {
    color: #adb5bd !important;
}

#component-details-table .component-description {
    color: #495057 !important;
    font-size: 0.75rem;
}

[data-bs-theme="dark"] #component-details-table .component-description {
    color: #ced4da !important;
}

#component-details-table .fw-bold {
    color: #212529;
}

[data-bs-theme="dark"] #component-details-table .fw-bold {
    color: #f8f9fa;
}

#component-details-table .badge {
    font-size: 0.7rem !important;
    font-weight: 500;
}

.table-responsive {
    max-height: 600px;
    overflow-y: auto;
}

@media (max-width: 768px) {
    #component-details-table th,
    #component-details-table td {
        padding: 0.25rem 0.5rem;
        font-size: 0.8rem;
    }
}
</style>
<div class="detail-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('home') }}">Home</a></li>
            {% if project %}
            <li class="breadcrumb-item"><a href="{{ url_for('project_dashboard', project_id=project.id) }}">{{ project.name }}</a></li>
            {% endif %}
            <li class="breadcrumb-item active">SBOM Details</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">SBOM Analysis Report</h1>
            <p class="text-muted">{{ data.bom_format }} v{{ data.spec_version }}</p>
        </div>
        <div>
            <button class="btn btn-outline-success me-2" onclick="triggerSBOMUpload()">
                <i data-feather="upload"></i> Upload New SBOM
            </button>
            <button class="btn btn-outline-primary me-2" onclick="exportToPDF()">
                <i data-feather="download"></i> Export PDF
            </button>
            <button class="btn btn-outline-primary" onclick="exportToJSON()">
                <i data-feather="file-text"></i> Export JSON
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value">{{ data.components.total }}</div>
                <div class="metric-label">Total Components</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-critical">{{ data.vulnerabilities.by_severity.critical }}</div>
                <div class="metric-label">Critical</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-high">{{ data.vulnerabilities.by_severity.high }}</div>
                <div class="metric-label">High</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-medium">{{ data.vulnerabilities.by_severity.medium }}</div>
                <div class="metric-label">Medium</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-low">{{ data.vulnerabilities.by_severity.low }}</div>
                <div class="metric-label">Low</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value">{{ data.vulnerabilities.total }}</div>
                <div class="metric-label">Total Vulnerabilities</div>
            </div>
        </div>
    </div>

    <!-- Vulnerability Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Vulnerability Distribution</h5>
                <div class="chart-container">
                    <canvas id="vulnerability-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Component Types</h5>
                <div class="chart-container">
                    <canvas id="component-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Details -->
    <div class="summary-card">
        <h5 class="card-title mb-3">Component Analysis</h5>
        
        <!-- Filter Controls -->
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Search Components</label>
                    <input type="text" class="form-control" id="component-search" placeholder="Search components...">
                </div>
                <div>
                    <label class="form-label">Filter by Type</label>
                    <select class="form-select" id="type-filter">
                        <option value="">All Types</option>
                        {% for type, count in data.components.by_type.items() %}
                        <option value="{{ type }}">{{ type.title() }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Sort By</label>
                    <select class="form-select" id="component-sort">
                        <option value="name">Name</option>
                        <option value="type">Type</option>
                        <option value="version">Version</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="sortComponentsTable()">
                        <i data-feather="arrow-up-down"></i> Sort
                    </button>
                </div>
            </div>
        </div>

        <!-- Components Summary Table -->
        <div class="table-responsive">
            <table class="table table-striped" id="components-table">
                <thead>
                    <tr>
                        <th>Component Type</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for type, count in data.components.by_type.items() %}
                    <tr>
                        <td>{{ type.title() }}</td>
                        <td>{{ count }}</td>
                        <td>{{ "%.1f"|format((count / data.components.total * 100)) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Component Details Table -->
    {% if data.components.details %}
    <div class="summary-card">
        <h5 class="card-title mb-3">Component Details</h5>
        
        <!-- Filter Controls -->
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Search Components</label>
                    <input type="text" class="form-control" id="component-detail-search" placeholder="Search by name, group, or version..." onkeyup="filterComponentTable()">
                </div>
                <div>
                    <label class="form-label">Filter by Type</label>
                    <select class="form-select" id="component-type-filter" onchange="filterComponentTable()">
                        <option value="">All Types</option>
                        {% for type, count in data.components.by_type.items() %}
                        <option value="{{ type }}">{{ type.title() }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped table-hover table-sm" id="component-details-table">
                <thead class="table-dark">
                    <tr>
                        <th onclick="sortComponentDetailsTable(0)" style="cursor: pointer;">Name <i data-feather="chevron-up"></i></th>
                        <th onclick="sortComponentDetailsTable(1)" style="cursor: pointer;">Version <i data-feather="chevron-up"></i></th>
                        <th onclick="sortComponentDetailsTable(2)" style="cursor: pointer;">Group <i data-feather="chevron-up"></i></th>
                        <th onclick="sortComponentDetailsTable(3)" style="cursor: pointer;">Type <i data-feather="chevron-up"></i></th>
                        <th onclick="sortComponentDetailsTable(4)" style="cursor: pointer;">Author <i data-feather="chevron-up"></i></th>
                        <th>Hashes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for component in data.components.details %}
                    <tr>
                        <td style="max-width: 250px;">
                            <div class="fw-bold text-truncate">{{ component.name }}</div>
                            {% if component.description and component.description != 'Unknown' %}
                            <small class="component-description text-truncate d-block">{{ component.description[:80] }}{% if component.description|length > 80 %}...{% endif %}</small>
                            {% endif %}
                        </td>
                        <td style="min-width: 100px;"><code class="small">{{ component.version }}</code></td>
                        <td style="max-width: 200px;" class="text-truncate">{{ component.group if component.group != 'Unknown' else '-' }}</td>
                        <td style="min-width: 80px;"><span class="badge bg-secondary small">{{ component.type }}</span></td>
                        <td style="max-width: 150px;" class="text-truncate">{{ component.author if component.author != 'Unknown' else '-' }}</td>
                        <td style="min-width: 100px;">
                            {% if component.hashes %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                    {{ component.hashes|length }}
                                </button>
                                <ul class="dropdown-menu">
                                    {% for hash in component.hashes %}
                                    <li class="dropdown-item-text">
                                        <small>
                                            <strong>{{ hash.algorithm }}:</strong><br>
                                            <code class="text-break small">{{ hash.value[:24] }}...</code>
                                        </small>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                            {% else %}
                            <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if data.components.total > data.components.details|length %}
        <div class="text-center mt-3">
            <small class="text-muted">
                Showing {{ data.components.details|length }} of {{ data.components.total }} components
            </small>
        </div>
        {% endif %}
    </div>
    {% endif %}

    <!-- Licenses -->
    {% if data.components.licenses %}
    <div class="summary-card">
        <h5 class="card-title mb-3">License Analysis</h5>
        <div class="row">
            {% for license in data.components.licenses %}
            <div class="col-md-3 mb-2">
                <span class="badge bg-info">{{ license }}</span>
            </div>
            {% endfor %}
        </div>
        <div class="mt-3">
            <small class="text-muted">{{ data.components.licenses|length }} unique license(s) detected across {{ data.components.total }} components</small>
        </div>
    </div>
    {% endif %}

    <!-- Raw Vulnerabilities (if available) -->
    {% if data.raw_data.vulnerabilities %}
    <div class="summary-card">
        <h5 class="card-title mb-3">Vulnerability Details</h5>
        
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Filter by Severity</label>
                    <select class="form-select" id="severity-filter">
                        <option value="">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Search CVE</label>
                    <input type="text" class="form-control" id="cve-search" placeholder="Search CVE ID...">
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped" id="vulnerabilities-table">
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>Severity</th>
                        <th>CVSS Score</th>
                        <th>Component</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in data.raw_data.vulnerabilities[:50] %}
                    <tr>
                        <td>
                            {% if vuln.id %}
                            <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.id }}" target="_blank">{{ vuln.id }}</a>
                            {% else %}
                            {{ vuln.bom_ref or 'N/A' }}
                            {% endif %}
                        </td>
                        <td>
                            {% set severity = vuln.ratings[0].severity.lower() if vuln.ratings else 'unknown' %}
                            <span class="badge badge-{{ severity }}">{{ severity.upper() }}</span>
                        </td>
                        <td>
                            {% if vuln.ratings and vuln.ratings[0].score %}
                            {{ vuln.ratings[0].score }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if vuln.affects %}
                            {{ vuln.affects[0].ref }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if vuln.description %}
                            {{ vuln.description[:100] }}{% if vuln.description|length > 100 %}...{% endif %}
                            {% else %}
                            No description available
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if data.raw_data.vulnerabilities|length > 50 %}
        <p class="text-muted text-center mt-3">
            Showing first 50 vulnerabilities out of {{ data.vulnerabilities.total }} total.
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Hidden file input for SBOM upload -->
<input type="file" id="sbom-file-input" accept=".json,.xml" style="display: none;" onchange="handleSBOMUpload(this)">

{% endblock %}

{% block scripts %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeVulnerabilityChart();
    initializeComponentChart();
});

// Function called from dashboard.js
function createSBOMChart(vulnerabilities) {
    const ctx = document.getElementById('sbom-chart');
    if (!ctx) return;
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    vulnerabilities.critical || 0,
                    vulnerabilities.high || 0,
                    vulnerabilities.medium || 0,
                    vulnerabilities.low || 0
                ],
                backgroundColor: [
                    'hsl(var(--critical))',
                    'hsl(var(--high))',
                    'hsl(var(--medium))',
                    'hsl(var(--low))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeVulnerabilityChart() {
    const ctx = document.getElementById('vulnerability-chart').getContext('2d');
    const vulnerabilities = {{ data.vulnerabilities.by_severity | tojson }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    vulnerabilities.critical,
                    vulnerabilities.high,
                    vulnerabilities.medium,
                    vulnerabilities.low
                ],
                backgroundColor: [
                    'hsl(var(--critical))',
                    'hsl(var(--high))',
                    'hsl(var(--medium))',
                    'hsl(var(--low))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeComponentChart() {
    const ctx = document.getElementById('component-chart').getContext('2d');
    const components = {{ data.components.by_type | tojson }};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(components).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
            datasets: [{
                label: 'Components',
                data: Object.values(components),
                backgroundColor: 'hsl(var(--primary))',
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Filter and sort functions
function sortComponentsTable() {
    const sortBy = document.getElementById('component-sort').value;
    let columnIndex;
    
    switch(sortBy) {
        case 'type': columnIndex = 0; break;
        case 'count': columnIndex = 1; break;
        default: columnIndex = 0;
    }
    
    sortTable('components-table', columnIndex, sortBy === 'count');
}

// Search and filter functionality
document.getElementById('component-search')?.addEventListener('input', function() {
    filterTable('components-table', this.value, 0);
});

document.getElementById('type-filter')?.addEventListener('change', function() {
    filterTable('components-table', this.value, 0);
});

document.getElementById('severity-filter')?.addEventListener('change', function() {
    filterTable('vulnerabilities-table', this.value, 1);
});

document.getElementById('cve-search')?.addEventListener('input', function() {
    filterTable('vulnerabilities-table', this.value, 0);
});

// Enhanced component detail table functions
function filterComponentTable() {
    const searchInput = document.getElementById('component-detail-search');
    const typeFilter = document.getElementById('component-type-filter');
    const table = document.getElementById('component-details-table');
    
    if (!table || !searchInput || !typeFilter) return;
    
    const tbody = table.querySelector('tbody');
    const rows = tbody.querySelectorAll('tr');
    
    const searchTerm = searchInput.value.toLowerCase();
    const selectedType = typeFilter.value.toLowerCase();
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const version = row.cells[1].textContent.toLowerCase();
        const group = row.cells[2].textContent.toLowerCase();
        const type = row.cells[3].textContent.toLowerCase();
        const author = row.cells[4].textContent.toLowerCase();
        
        const matchesSearch = !searchTerm || 
            name.includes(searchTerm) || 
            version.includes(searchTerm) || 
            group.includes(searchTerm) || 
            author.includes(searchTerm);
            
        const matchesType = !selectedType || type.includes(selectedType);
        
        if (matchesSearch && matchesType) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    updateVisibleComponentCount(visibleCount, rows.length);
}

function updateVisibleComponentCount(visible, total) {
    let indicator = document.getElementById('component-count-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'component-count-indicator';
        indicator.className = 'text-muted small mt-2';
        const table = document.getElementById('component-details-table');
        if (table) {
            table.parentNode.insertBefore(indicator, table.nextSibling);
        }
    }
    
    if (visible === total) {
        indicator.textContent = `Showing all ${total} components`;
    } else {
        indicator.textContent = `Showing ${visible} of ${total} components`;
    }
}

function sortComponentDetailsTable(columnIndex) {
    const table = document.getElementById('component-details-table');
    if (!table) return;
    
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    
    // Determine sort direction
    const header = table.querySelectorAll('th')[columnIndex];
    const isAscending = !header.classList.contains('sort-desc');
    
    // Clear all sort indicators
    table.querySelectorAll('th').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Set new sort indicator
    header.classList.add(isAscending ? 'sort-asc' : 'sort-desc');
    
    rows.sort((a, b) => {
        let aVal = a.cells[columnIndex].textContent.trim();
        let bVal = b.cells[columnIndex].textContent.trim();
        
        // Handle numeric sorting for version numbers
        if (columnIndex === 1) { // Version column
            const aVersion = aVal.replace(/[^\d.]/g, '');
            const bVersion = bVal.replace(/[^\d.]/g, '');
            const result = aVersion.localeCompare(bVersion, undefined, { numeric: true });
            return isAscending ? result : -result;
        }
        
        const result = aVal.localeCompare(bVal, undefined, { sensitivity: 'base' });
        return isAscending ? result : -result;
    });
    
    rows.forEach(row => tbody.appendChild(row));
}

function exportToPDF() {
    window.print();
}

function exportToJSON() {
    const data = {{ data | tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sbom-report.json';
    a.click();
    URL.revokeObjectURL(url);
}

function triggerSBOMUpload() {
    document.getElementById('sbom-file-input').click();
}

function handleSBOMUpload(input) {
    const file = input.files[0];
    if (!file) return;
    
    // Validate file type
    const validTypes = ['application/json', 'text/xml', 'application/xml'];
    const validExtensions = ['.json', '.xml'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    
    if (!validTypes.includes(file.type) && !validExtensions.includes(fileExtension)) {
        showNotification('error', 'Please select a valid SBOM file (.json or .xml)');
        return;
    }
    
    // Show loading state
    const uploadBtn = document.querySelector('[onclick="triggerSBOMUpload()"]');
    const originalText = uploadBtn.innerHTML;
    uploadBtn.innerHTML = '<i data-feather="loader"></i> Uploading...';
    uploadBtn.disabled = true;
    
    // Create form data
    const formData = new FormData();
    formData.append('file', file);
    formData.append('report_type', 'sbom');
    
    // Get project ID from current URL
    const projectId = window.location.pathname.split('/')[2];
    
    // Upload file
    fetch(`/project/${projectId}/upload`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('success', 'SBOM file uploaded successfully! Reloading page...');
            setTimeout(() => {
                window.location.reload();
            }, 2000);
        } else {
            showNotification('error', data.error || 'Failed to upload SBOM file');
        }
    })
    .catch(error => {
        console.error('Upload error:', error);
        showNotification('error', 'Error uploading file. Please try again.');
    })
    .finally(() => {
        // Restore button state
        uploadBtn.innerHTML = originalText;
        uploadBtn.disabled = false;
        feather.replace();
        
        // Clear file input
        input.value = '';
    });
}
</script>
{% endblock %}
