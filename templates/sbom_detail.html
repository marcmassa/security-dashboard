{% extends "base.html" %}

{% block title %}SBOM Report Details - Security Dashboard{% endblock %}

{% block content %}
<div class="detail-container">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
            <li class="breadcrumb-item active">SBOM Details</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h2 mb-0">SBOM Analysis Report</h1>
            <p class="text-muted">{{ data.bom_format }} v{{ data.spec_version }}</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="exportToPDF()">
                <i data-feather="download"></i> Export PDF
            </button>
            <button class="btn btn-outline-primary" onclick="exportToJSON()">
                <i data-feather="file-text"></i> Export JSON
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value">{{ data.components.total }}</div>
                <div class="metric-label">Total Components</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-critical">{{ data.vulnerabilities.by_severity.critical }}</div>
                <div class="metric-label">Critical</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-high">{{ data.vulnerabilities.by_severity.high }}</div>
                <div class="metric-label">High</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-medium">{{ data.vulnerabilities.by_severity.medium }}</div>
                <div class="metric-label">Medium</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value severity-low">{{ data.vulnerabilities.by_severity.low }}</div>
                <div class="metric-label">Low</div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="summary-card text-center">
                <div class="metric-value">{{ data.vulnerabilities.total }}</div>
                <div class="metric-label">Total Vulnerabilities</div>
            </div>
        </div>
    </div>

    <!-- Vulnerability Chart -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Vulnerability Distribution</h5>
                <div class="chart-container">
                    <canvas id="vulnerability-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="summary-card">
                <h5 class="card-title">Component Types</h5>
                <div class="chart-container">
                    <canvas id="component-chart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Details -->
    <div class="summary-card">
        <h5 class="card-title mb-3">Component Analysis</h5>
        
        <!-- Filter Controls -->
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Search Components</label>
                    <input type="text" class="form-control" id="component-search" placeholder="Search components...">
                </div>
                <div>
                    <label class="form-label">Filter by Type</label>
                    <select class="form-select" id="type-filter">
                        <option value="">All Types</option>
                        {% for type, count in data.components.by_type.items() %}
                        <option value="{{ type }}">{{ type.title() }} ({{ count }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label class="form-label">Sort By</label>
                    <select class="form-select" id="component-sort">
                        <option value="name">Name</option>
                        <option value="type">Type</option>
                        <option value="version">Version</option>
                    </select>
                </div>
                <div>
                    <button class="btn btn-outline-primary" onclick="sortComponentsTable()">
                        <i data-feather="arrow-up-down"></i> Sort
                    </button>
                </div>
            </div>
        </div>

        <!-- Components Summary Table -->
        <div class="table-responsive">
            <table class="table table-striped" id="components-table">
                <thead>
                    <tr>
                        <th>Component Type</th>
                        <th>Count</th>
                        <th>Percentage</th>
                    </tr>
                </thead>
                <tbody>
                    {% for type, count in data.components.by_type.items() %}
                    <tr>
                        <td>{{ type.title() }}</td>
                        <td>{{ count }}</td>
                        <td>{{ "%.1f"|format((count / data.components.total * 100)) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Licenses -->
    {% if data.components.licenses %}
    <div class="summary-card">
        <h5 class="card-title mb-3">License Analysis</h5>
        <div class="row">
            {% for license in data.components.licenses %}
            <div class="col-md-3 mb-2">
                <span class="badge badge-info">{{ license }}</span>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Raw Vulnerabilities (if available) -->
    {% if data.raw_data.vulnerabilities %}
    <div class="summary-card">
        <h5 class="card-title mb-3">Vulnerability Details</h5>
        
        <div class="filter-controls mb-3">
            <div class="filter-grid">
                <div>
                    <label class="form-label">Filter by Severity</label>
                    <select class="form-select" id="severity-filter">
                        <option value="">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div>
                    <label class="form-label">Search CVE</label>
                    <input type="text" class="form-control" id="cve-search" placeholder="Search CVE ID...">
                </div>
            </div>
        </div>

        <div class="table-responsive">
            <table class="table table-striped" id="vulnerabilities-table">
                <thead>
                    <tr>
                        <th>CVE ID</th>
                        <th>Severity</th>
                        <th>CVSS Score</th>
                        <th>Component</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for vuln in data.raw_data.vulnerabilities[:50] %}
                    <tr>
                        <td>
                            {% if vuln.id %}
                            <a href="https://nvd.nist.gov/vuln/detail/{{ vuln.id }}" target="_blank">{{ vuln.id }}</a>
                            {% else %}
                            {{ vuln.bom_ref or 'N/A' }}
                            {% endif %}
                        </td>
                        <td>
                            {% set severity = vuln.ratings[0].severity.lower() if vuln.ratings else 'unknown' %}
                            <span class="badge badge-{{ severity }}">{{ severity.upper() }}</span>
                        </td>
                        <td>
                            {% if vuln.ratings and vuln.ratings[0].score %}
                            {{ vuln.ratings[0].score }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if vuln.affects %}
                            {{ vuln.affects[0].ref }}
                            {% else %}
                            N/A
                            {% endif %}
                        </td>
                        <td>
                            {% if vuln.description %}
                            {{ vuln.description[:100] }}{% if vuln.description|length > 100 %}...{% endif %}
                            {% else %}
                            No description available
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        {% if data.raw_data.vulnerabilities|length > 50 %}
        <p class="text-muted text-center mt-3">
            Showing first 50 vulnerabilities out of {{ data.vulnerabilities.total }} total.
        </p>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Initialize charts
document.addEventListener('DOMContentLoaded', function() {
    initializeVulnerabilityChart();
    initializeComponentChart();
});

function initializeVulnerabilityChart() {
    const ctx = document.getElementById('vulnerability-chart').getContext('2d');
    const vulnerabilities = {{ data.vulnerabilities.by_severity | tojson }};
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Critical', 'High', 'Medium', 'Low'],
            datasets: [{
                data: [
                    vulnerabilities.critical,
                    vulnerabilities.high,
                    vulnerabilities.medium,
                    vulnerabilities.low
                ],
                backgroundColor: [
                    'hsl(var(--critical))',
                    'hsl(var(--high))',
                    'hsl(var(--medium))',
                    'hsl(var(--low))'
                ],
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function initializeComponentChart() {
    const ctx = document.getElementById('component-chart').getContext('2d');
    const components = {{ data.components.by_type | tojson }};
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Object.keys(components).map(key => key.charAt(0).toUpperCase() + key.slice(1)),
            datasets: [{
                label: 'Components',
                data: Object.values(components),
                backgroundColor: 'hsl(var(--primary))',
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1
                    }
                }
            }
        }
    });
}

// Filter and sort functions
function sortComponentsTable() {
    const sortBy = document.getElementById('component-sort').value;
    let columnIndex;
    
    switch(sortBy) {
        case 'type': columnIndex = 0; break;
        case 'count': columnIndex = 1; break;
        default: columnIndex = 0;
    }
    
    sortTable('components-table', columnIndex, sortBy === 'count');
}

// Search and filter functionality
document.getElementById('component-search')?.addEventListener('input', function() {
    filterTable('components-table', this.value, 0);
});

document.getElementById('type-filter')?.addEventListener('change', function() {
    filterTable('components-table', this.value, 0);
});

document.getElementById('severity-filter')?.addEventListener('change', function() {
    filterTable('vulnerabilities-table', this.value, 1);
});

document.getElementById('cve-search')?.addEventListener('input', function() {
    filterTable('vulnerabilities-table', this.value, 0);
});

function exportToPDF() {
    window.print();
}

function exportToJSON() {
    const data = {{ data | tojson }};
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'sbom-report.json';
    a.click();
    URL.revokeObjectURL(url);
}
</script>
{% endblock %}
